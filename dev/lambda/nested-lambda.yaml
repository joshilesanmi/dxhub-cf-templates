AWSTemplateFormatVersion: 2010-09-09

Parameters:

  EnvironmentName:
    Description: The Stack Name for naming the resources
    Type: String
    #Default: dxhub

  AccountId:
    Description: The account id for the client
    Type: String
    # Default: '012615398682'

  Region:
    Description: The AWS region for the client infrastructure
    Type: String
    # Default: 'eu-west-2'

  GithubTiggerFunctionName:
    Description: The name lambda function for github tigger
    Type: String
    # Default: 'dxhub-github-trigger-codepipeline'

  CodedeployFunctionName:
    Description: The name of first service code deploy lifecycle
    Type: String
    # Default: 'dxhub-codedeploy-lifecycle'

Resources:

# 1. ECR Repositories

  GithubTiggerECRRepository:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub ${EnvironmentName}-${GithubTiggerFunctionName}

  CodeDeployECRRepository2:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub ${EnvironmentName}-${CodedeployFunctionName}

# 2. Lambda Functions

  GithubTiggerLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub ${GithubTiggerECRRepository}
      PackageType: Image
      Code:
        ImageUri: !Sub  ${AccountId}.dkr.ecr.${Region}.amazonaws.com/${GithubTiggerECRRepository}
      Role: !ImportValue GithubTriggerCodePipelineArn
      Timeout: 30
      MemorySize: 256

  CodeDeployLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub ${CodedeployFunctionName}
      PackageType: Image
      Code:
        ImageUri: !Sub  ${AccountId}.dkr.ecr.${Region}.amazonaws.com/${CodedeployFunctionName}
      Role: !ImportValue GithubTriggerCodePipelineArn
      Timeout: 30
      MemorySize: 256

Outputs:
  GithubTiggerFunction:
    Description: Export value for the cluster lambda function for github trigger
    Value: !GetAtt GithubTiggerLambdaFunction.Arn
    Export:
      Name: GithubTiggerLambdaFunctionArn

  CodeDeployLambdaFunction:
    Description: Export value for the cluster lambda function for codelifecycle
    Value: !GetAtt CodeDeployLambdaFunction.Arn
    Export:
      Name: CodeDeployLambdaFunctionArn

